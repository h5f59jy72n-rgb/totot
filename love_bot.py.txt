import asyncio
import random
from datetime import date, time

from telegram import (
    Update,
    InputFile,
    InlineKeyboardButton,
    InlineKeyboardMarkup,
)
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    CallbackQueryHandler,
    ContextTypes,
)

# ================= –ù–ê–°–¢–†–û–ô–ö–ò =================
TOKEN = "8289400217:AAH2HYznYpuc-QOc4W8y0KrDpY_1rQfIbCY"
PHOTO_PATH = "love_photo.jpg"
RELATIONSHIP_START = date(2025, 10, 24)
# =============================================


# ---------- –¢–ï–ö–°–¢ –ü–†–ò /start ----------
START_TEXT = (
    "–ö–∞—Ç—è ‚ù§Ô∏è\n\n"
    "–Ø ‚Äî –î–µ–Ω–∏—Å.\n"
    "–Ø –ª—é–±–ª—é —Ç–µ–±—è –æ—á–µ–Ω—å —Å–∏–ª—å–Ω–æ üíûüíñ\n\n"
    "–Ø –Ω–∞–ø–∏—Å–∞–ª —ç—Ç–æ–≥–æ –±–æ—Ç–∞ —Ä–∞–¥–∏ —Ç–µ–±—è,\n"
    "—á—Ç–æ–±—ã –¥–∞–∂–µ –∫–æ–≥–¥–∞ –º–µ–Ω—è –Ω–µ—Ç —Ä—è–¥–æ–º,\n"
    "—Ç—ã –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –∑–Ω–∞–ª–∞,\n"
    "–∫–∞–∫ —Å–∏–ª—å–Ω–æ —Ç—ã –º–Ω–µ –¥–æ—Ä–æ–≥–∞ üíì\n\n"
    "–≠—Ç–æ—Ç –±–æ—Ç –±—É–¥–µ—Ç –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 22:22\n"
    "–Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å —Ç–µ–±–µ –æ –º–æ–µ–π –ª—é–±–≤–∏ ‚ù§Ô∏è\n\n"
    "–ü–æ–º–Ω–∏:\n"
    "—è –≤—Å–µ–≥–¥–∞ –¥—É–º–∞—é –æ —Ç–µ–±–µ\n"
    "–∏ –æ—á–µ–Ω—å —Ç–µ–±—è –ª—é–±–ª—é üíò"
)

# ---------- –ï–ñ–ï–î–ù–ï–í–ù–´–ï –¢–ï–ö–°–¢–´ ----------
DAILY_TEXTS = [
    "–ü–æ–º–Ω–∏, —è —Ç–µ–±—è –ª—é–±–ª—é ‚ù§Ô∏è –¢—ã ‚Äî —Å–∞–º–æ–µ –¥–æ—Ä–æ–≥–æ–µ, —á—Ç–æ —É –º–µ–Ω—è –µ—Å—Ç—å üíû",
    "–ü–æ–º–Ω–∏, —è —Ç–µ–±—è –ª—é–±–ª—é ‚ù§Ô∏è –î–∞–∂–µ –µ—Å–ª–∏ –¥–µ–Ω—å –±—ã–ª —Ç—è–∂—ë–ª—ã–π ‚Äî —è —Ä—è–¥–æ–º –º—ã—Å–ª—è–º–∏ üíò",
    "–ü–æ–º–Ω–∏, —è —Ç–µ–±—è –ª—é–±–ª—é ‚ù§Ô∏è –í—Å–µ–≥–¥–∞. –°–µ–≥–æ–¥–Ω—è, –∑–∞–≤—Ç—Ä–∞ –∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å üíñ",
    "–ü–æ–º–Ω–∏, —è —Ç–µ–±—è –ª—é–±–ª—é ‚ù§Ô∏è –¢—ã ‚Äî –º–æ–π —Å–∞–º—ã–π —Ç—ë–ø–ª—ã–π —á–µ–ª–æ–≤–µ–∫ üíû",
    "–ü–æ–º–Ω–∏, —è —Ç–µ–±—è –ª—é–±–ª—é ‚ù§Ô∏è –ò –æ—á–µ–Ω—å —Å–∫—É—á–∞—é –ø–æ —Ç–µ–±–µ üíì",
]

# ---------- –¢–ï–ö–°–¢ –ù–ê 100 –î–ù–ï–ô ----------
TEXT_100_DAYS = (
    "üéâüíØ –ö–∞—Ç—è, —Å–µ–≥–æ–¥–Ω—è –æ—Å–æ–±–µ–Ω–Ω—ã–π –¥–µ–Ω—å ‚ù§Ô∏è\n\n"
    "–ú—ã –≤–º–µ—Å—Ç–µ —É–∂–µ 100 –¥–Ω–µ–π üíë\n\n"
    "–ó–∞ —ç—Ç–∏ 100 –¥–Ω–µ–π —Ç—ã —Å—Ç–∞–ª–∞ –¥–ª—è –º–µ–Ω—è\n"
    "–Ω–µ –ø—Ä–æ—Å—Ç–æ –ª—é–±–∏–º—ã–º —á–µ–ª–æ–≤–µ–∫–æ–º ‚Äî\n"
    "—Ç—ã —Å—Ç–∞–ª–∞ —á–∞—Å—Ç—å—é –º–æ–µ–π –∂–∏–∑–Ω–∏,\n"
    "–º–æ–µ–≥–æ —Å–µ—Ä–¥—Ü–∞ –∏ –∫–∞–∂–¥–æ–≥–æ –º–æ–µ–≥–æ –¥–Ω—è üíñ\n\n"
    "–Ø –ª—é–±–ª—é —Ç–µ–±—è —Ç–∞–∫,\n"
    "–∫–∞–∫ —Ä–∞–Ω—å—à–µ –¥–∞–∂–µ –Ω–µ –∑–Ω–∞–ª, —á—Ç–æ –º–æ–∂–Ω–æ –ª—é–±–∏—Ç—å.\n"
    "–õ—é–±–ª—é —Ç–≤–æ—é —É–ª—ã–±–∫—É,\n"
    "—Ç–≤–æ–π –≥–æ–ª–æ—Å,\n"
    "—Ç–≤–æ–π —Å–º–µ—Ö,\n"
    "—Ç–≤–æ–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä,\n"
    "–¥–∞–∂–µ —Ç–≤–æ–∏ –ø–µ—Ä–µ–∂–∏–≤–∞–Ω–∏—è ‚Äî –ø–æ—Ç–æ–º—É —á—Ç–æ —ç—Ç–æ —Ç—ã üíû\n\n"
    "–° —Ç–æ–±–æ–π –º–∏—Ä —Å—Ç–∞–ª —Ç–µ–ø–ª–µ–µ,\n"
    "–¥–Ω–∏ —Å—Ç–∞–ª–∏ —è—Ä—á–µ,\n"
    "–∞ –±—É–¥—É—â–µ–µ ‚Äî –∂–µ–ª–∞–Ω–Ω–µ–µ ‚ú®\n\n"
    "–Ø –±–ª–∞–≥–æ–¥–∞—Ä–µ–Ω —Ç–µ–±–µ –∑–∞ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É,\n"
    "–∑–∞ –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ,\n"
    "–∑–∞ –∫–∞–∂–¥—É—é —ç–º–æ—Ü–∏—é,\n"
    "–∑–∞ —Ç–æ, —á—Ç–æ —Ç—ã –µ—Å—Ç—å –≤ –º–æ–µ–π –∂–∏–∑–Ω–∏ ‚ù§Ô∏è\n\n"
    "–ü–æ–º–Ω–∏, —è —Ç–µ–±—è –ª—é–±–ª—é.\n"
    "–õ—é–±–ª—é —Å–∏–ª—å–Ω–æ.\n"
    "–õ—é–±–ª—é –∏—Å–∫—Ä–µ–Ω–Ω–µ.\n"
    "–õ—é–±–ª—é –≤—Å–µ–º —Å–µ—Ä–¥—Ü–µ–º üíò\n\n"
    "–ò —è —Ö–æ—á—É, —á—Ç–æ–±—ã —ç—Ç–∏—Ö –¥–Ω–µ–π\n"
    "–±—ã–ª–æ –Ω–µ 100,\n"
    "–Ω–µ 1000 ‚Äî\n"
    "–∞ —Ü–µ–ª–∞—è –≤–µ—á–Ω–æ—Å—Ç—å –≤–º–µ—Å—Ç–µ üíç‚ù§Ô∏è"
)


# ---------- –ö–ù–û–ü–ö–ê ----------
def love_keyboard():
    return InlineKeyboardMarkup(
        [[InlineKeyboardButton("–õ—é–±–ª—é —Ç–µ–±—è ‚ù§Ô∏è", callback_data="love")]]
    )


# ---------- –°–ß–Å–¢–ß–ò–ö –î–ù–ï–ô ----------
def days_together():
    today = date.today()
    delta = (today - RELATIONSHIP_START).days
    return max(delta, 0)


# ---------- –ü–û–ó–î–†–ê–í–õ–ï–ù–ò–ï –ö–ê–ñ–î–´–ï 10 –î–ù–ï–ô ----------
def anniversary_text(days):
    return (
        f"\n\nüéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è—é –Ω–∞—Å ‚ù§Ô∏è\n"
        f"–ú—ã –≤–º–µ—Å—Ç–µ —É–∂–µ {days} –¥–Ω–µ–π üíë\n"
        f"–ò —è –ª—é–±–ª—é —Ç–µ–±—è —Å –∫–∞–∂–¥—ã–º –¥–Ω—ë–º –≤—Å—ë —Å–∏–ª—å–Ω–µ–µ üíñ"
    )


# ---------- /start ----------
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id

    await context.bot.send_photo(
        chat_id=chat_id,
        photo=InputFile(PHOTO_PATH),
        caption=START_TEXT,
        reply_markup=love_keyboard(),
    )

    context.application.chat_data[chat_id] = True


# ---------- –ö–ù–û–ü–ö–ê ----------
async def love_button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    await query.message.reply_text(
        "–Ø –∑–Ω–∞—é ‚ù§Ô∏è –ò —è —Ç–µ–±—è –æ—á–µ–Ω—å –ª—é–±–ª—é üíû"
    )


# ---------- –ï–ñ–ï–î–ù–ï–í–ù–û–ï –°–û–û–ë–©–ï–ù–ò–ï ----------
async def daily_message(context: ContextTypes.DEFAULT_TYPE):
    days = days_together()

    if days == 100:
        full_text = TEXT_100_DAYS
    else:
        base_text = random.choice(DAILY_TEXTS)
        full_text = (
            f"{base_text}\n\n"
            f"üíë –ú—ã –≤–º–µ—Å—Ç–µ —É–∂–µ {days} –¥–Ω–µ–π"
        )

        if days != 0 and days % 10 == 0:
            full_text += anniversary_text(days)

    for chat_id in context.application.chat_data.keys():
        try:
            await context.bot.send_photo(
                chat_id=chat_id,
                photo=InputFile(PHOTO_PATH),
                caption=full_text,
                reply_markup=love_keyboard(),
            )
        except Exception:
            pass


# ---------- –ó–ê–ü–£–°–ö ----------
async def main():
    app = ApplicationBuilder().token(TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CallbackQueryHandler(love_button, pattern="love"))

    app.job_queue.run_daily(
        daily_message,
        time=time(hour=22, minute=22),
    )

    await app.run_polling()


if __name__ == "__main__":
    asyncio.run(main())